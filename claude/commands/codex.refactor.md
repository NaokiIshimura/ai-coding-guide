---
allowed-tools: Read, Bash(codex:*)
description: Codexにリファクタリングを依頼する
---

## タスク

Codexにコードのリファクタリングを依頼します。コード品質、可読性、保守性、パフォーマンスの改善を行います。

### 1. リファクタリング対象の確認

ユーザーが指定したファイルを確認します：

```bash
# リファクタリング対象の確認
if [ -z "$TARGET" ]; then
    echo "エラー: リファクタリング対象を指定してください"
    echo "使用例: /codex.refactor src/utils/helper.ts"
    exit 1
fi

if [ ! -f "$TARGET" ]; then
    echo "エラー: ファイルが見つかりません: $TARGET"
    exit 1
fi

echo "リファクタリング対象: $TARGET"
```

### 2. 現在のコードの読み込み

リファクタリング前のコードを読み込みます：

```bash
# コードの読み込み
CURRENT_CODE=$(cat "$TARGET")
```

### 3. リファクタリングプロンプトの生成

改善方針を含むプロンプトを生成します：

```markdown
# リファクタリング依頼

## 対象ファイル
<ファイルパス>

## 現在のコード
```<language>
<現在のコード>
```

## リファクタリング方針

### 1. コード品質の改善
- DRY原則の適用（重複コードの排除）
- SOLID原則の遵守
- 適切な抽象化レベルの維持
- マジックナンバーの定数化
- 早期リターンの活用

### 2. 可読性の向上
- 意味のある変数名・関数名への変更
- 複雑な条件式の簡略化
- 関数の分割（推奨: 50行以内）
- ネストの削減（推奨: 3レベル以内）
- 適切なコメントの追加

### 3. 保守性の向上
- 関数の単一責任原則の適用
- 依存関係の明確化
- テスタビリティの向上
- エラーハンドリングの改善

### 4. パフォーマンスの最適化
- 不要な計算の削減
- アルゴリズムの最適化
- メモリ使用量の削減
- キャッシングの活用（必要に応じて）

## プロジェクト規約
- @~/ai-coding-guide/guides/common.md の遵守
- ファイル末尾は空行で終わる
- 周辺のコードを参考にコメントの言語を決定
- 既存のコーディングスタイルを維持

## 出力形式

### リファクタリング後のコード
```<language>
<改善後のコード>
```

### 変更内容のサマリー
1. <変更点1>
2. <変更点2>
...

### 改善効果
- **可読性**: <改善内容>
- **保守性**: <改善内容>
- **パフォーマンス**: <改善内容>

## 注意事項
- 元のコードの機能を変更しないこと
- テストケースがある場合は互換性を保つこと
- 破壊的変更は避けること
```

### 4. Codex実行

`codex exec` コマンドでリファクタリングを実行します：

```bash
# タイムスタンプ生成
TIMESTAMP=$(TZ=Asia/Tokyo date +"%Y_%m%d_%H%M_%S")

# 出力ディレクトリ
OUTPUT_DIR=".claude/plans/codex"
mkdir -p "$OUTPUT_DIR"

# Codex実行
codex exec \
  --model auto \
  --sandbox workspace-write \
  --ask-for-approval on-failure \
  "$PROMPT"

# 結果を記録
EXIT_CODE=$?
RESULT_FILE="$OUTPUT_DIR/${TIMESTAMP}_refactor_result.md"
```

### 5. リファクタリング結果の整形と保存

結果をマークダウン形式で保存します：

```markdown
# Codex実行結果: リファクタリング

## 実行情報

- **実行日時**: $(TZ=Asia/Tokyo date +"%Y年%m月%d日 %H:%M:%S")
- **操作種別**: refactor
- **対象ファイル**: <ファイルパス>
- **終了コード**: $EXIT_CODE

## 実行コマンド

```bash
codex exec --model auto --sandbox workspace-write --ask-for-approval on-failure
```

## リファクタリング前のコード

```<language>
<元のコード>
```

## リファクタリング後のコード

<Codexが生成したコード>

## 変更内容

<Codexによる変更内容の説明>

## 改善効果

<改善された点のサマリー>

## 次のアクション

1. リファクタリング後のコードを確認
2. テストを実行して動作を検証
3. レビューを実施（/codex.reviewを使用）
4. 問題なければコミット
```

### 6. ユーザーへの通知

リファクタリング完了後、結果を通知します：

```
Codexによるリファクタリングが完了しました。

結果ファイル: .claude/plans/codex/<timestamp>_refactor_result.md

変更内容:
- <主な変更点1>
- <主な変更点2>
- <主な変更点3>

次のステップ:
- リファクタリング後のコードを確認してください
- テストを実行してください: npm test
- 動作確認後、変更をコミットしてください
```

## リファクタリングの種類

### 1. 命名の改善
- 意味のある変数名への変更
- 一貫性のある命名規則の適用
- 略語の展開（必要に応じて）

### 2. 構造の改善
- 長い関数の分割
- 重複コードの抽出
- 条件分岐の簡略化
- ネストの削減

### 3. 設計の改善
- デザインパターンの適用
- SOLID原則の適用
- 依存性の逆転
- インターフェースの抽出

### 4. パフォーマンスの改善
- アルゴリズムの最適化
- 不要な計算の削除
- キャッシングの導入
- 遅延評価の活用

## エラーハンドリング

### ファイルが見つからない場合

```
エラー: リファクタリング対象のファイルが見つかりません

確認事項:
- ファイルパスが正しいか
- ファイルが存在するか
- 作業ディレクトリが正しいか

使用例:
/codex.refactor src/utils/helper.ts
```

### Codex実行失敗時

```
エラー: Codex実行が失敗しました（終了コード: <code>）

考えられる原因:
- コードが複雑すぎてリファクタリングが困難
- ファイルが大きすぎる
- 依存関係が不明瞭

対処方法:
1. エラー内容を確認: .claude/plans/codex/<timestamp>_refactor_result.md
2. ファイルを小さな単位に分割してリファクタリング
3. より具体的な改善方針を指定して再実行
```

### テスト失敗時

```
警告: リファクタリング後にテストが失敗しました

対処方法:
1. リファクタリング前後の差分を確認
2. 機能が変更されていないか検証
3. 必要に応じて元に戻す
4. より慎重なリファクタリングを再実行
```

## 使用例

### 基本的な使用方法

```
/codex.refactor src/utils/helper.ts
```

### 特定の改善方針を指定

```
/codex.refactor src/utils/helper.ts
可読性向上に重点を置いてリファクタリングしてください
```

### パフォーマンス重視

```
/codex.refactor src/services/data-processor.ts
パフォーマンス最適化を優先してください
```

### テスタビリティ向上

```
/codex.refactor src/components/UserForm.tsx
テストしやすい構造にリファクタリングしてください
```

## 注意事項

- **重要**: リファクタリング後は必ずテストを実行してください
- 大規模なリファクタリングは小さな単位に分割することを推奨します
- 既存の機能を変更しないよう注意してください
- リファクタリング前後で差分を確認してください: `git diff`
- 問題があれば元に戻すことができます: `git checkout <file>`
- テストカバレッジを維持・向上させてください
