---
allowed-tools: Write, Read, Bash(git:*), Bash(TZ='Asia/Tokyo' date '+%Y_%m%d_%H%M_%S'), Glob, Grep, Task
description: 実行計画（plan.md）を出力する
---

## コンテキスト

- 現在のブランチ: !`git branch --show-current`
- 現在のディレクトリ: !`pwd`
- 現在の日時（日本時間）: !`TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M:%S'`

## タスク

現在までの作業状況や調査結果を整理して、実行計画（plan.md）として出力してください。

### 実施手順

1. **出力内容の確認**
   - ユーザーに以下を確認：
     - 実行計画のタイトル（タスクやプロジェクトの名称）
     - チケット番号またはタスク識別子（ブランチ名から推測可能な場合は自動取得）
     - 出力先ディレクトリ（デフォルト: `.claude/plans/<チケット番号>/`）

2. **情報の収集と整理**
   - 現在の会話履歴から作業状況を分析
   - 関連するファイルや変更内容を確認
   - git差分がある場合は変更内容を要約
   - 必要に応じて既存のドキュメントや設定を参照
   - 既存のplan.md、requirements.md、design.md、tasks.mdがあれば参照

3. **出力先ディレクトリの作成**
   - `.claude/plans/<チケット番号>/` ディレクトリを作成（存在しない場合）
   - チケット番号が不明な場合は `.claude/plans/tmp/` を使用

4. **実行計画ドキュメントの作成**
   - Taskツールで `plan-writer` エージェントを呼び出し、plan.mdを作成
   - 呼び出し時に以下の情報を渡す：
     - 実行計画のタイトル
     - チケット番号またはタスク識別子
     - 収集した作業状況・調査結果のサマリー
     - 出力先ディレクトリ

5. **ファイル名の生成**
   - タイムスタンプを含むファイル名を生成：
     - `YYYY_MMDD_HHMM_SS_plan.md`
   - タイムスタンプは日本時間: `TZ='Asia/Tokyo' date '+%Y_%m%d_%H%M_%S'`

6. **出力完了の報告**
   - 出力したファイルのパス
   - plan.mdの概要（ステップ数、想定時間など）
   - 次のアクション項目

### plan.md の標準構造

plan-writerエージェントが以下の構造でplan.mdを作成します：

1. **概要**: タスクの目的、スコープ、期待される成果
2. **実行計画**: ステップバイステップの実行手順（各ステップに目的、作業内容、使用ツール、完了条件を含む）
3. **関連ファイル**: 修正対象、参照ファイル、新規作成ファイル
4. **検証手順**: テスト、品質チェック
5. **注意点・リスク**: 潜在的な問題、フォールバック

詳細なテンプレートは `claude/agents/plan-writer.md` を参照してください。

### 注意事項

- **機密情報の保護**: パスワード、APIキー、トークンなどの機密情報は出力しない
- **タイムスタンプ**: 必ず日本時間のタイムスタンプを使用（`TZ='Asia/Tokyo' date '+%Y_%m%d_%H%M_%S'`）
- **バージョン管理**: 新しいタイムスタンプのファイルとして保存し、既存ファイルは上書きしない
- **ファイル末尾**: ファイルの末尾に空行を追加
- **日本語**: plan.mdは日本語で記述

### 期待される成果

1. 明確で実行可能なステップバイステップの計画
2. 実装に必要な全ての情報を含む包括的な計画書
3. リスクと対策を考慮した現実的な計画

### 使い分けガイド

**`/md.output.plan` を使う場合**:
- 軽量な実行計画で十分（単一ファイル: plan.md）
- 個人作業やプロトタイピング
- 短期タスクやシンプルな実装
- 既にrequirements/design.mdがあり、実行計画のみ欲しい

**`/md.output.spec` を使う場合**:
- 正式な実装計画が必要（3ファイル: requirements/design/tasks.md）
- チーム共有用の詳細な仕様書・設計書が必要
- 複雑な機能の実装で、要件・設計・タスクを分離したい
