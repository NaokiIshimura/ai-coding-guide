---
allowed-tools: Write, Read, Bash(git:*), Bash(TZ='Asia/Tokyo' date '+%Y_%m%d_%H%M_%S'), Bash(mkdir:*), Glob, Grep, Task
description: 実行計画（plan.md）を作成する
---

## コンテキスト

- 現在のブランチ: !`git branch --show-current`
- 現在のディレクトリ: !`pwd`
- 現在の日時（日本時間）: !`TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M:%S'`

## タスク

収集した情報を基に、実行計画（plan.md）を作成してください。

### 実施手順

1. **チケット番号/識別子の確認**
   - ユーザーからチケット番号が提供されている場合は、それを使用
   - 提供されていない場合は、現在のgitブランチ名から推測
   - 推測できない場合は、ユーザーに確認

2. **出力先ディレクトリの作成**
   - チケット番号がある場合: `.claude/plans/<チケット番号>/`
   - チケット番号がない場合: `.claude/plans/tmp/`
   ```bash
   mkdir -p .claude/plans/<識別子>/
   ```

3. **タイムスタンプの生成**
   ```bash
   TZ='Asia/Tokyo' date '+%Y_%m%d_%H%M_%S'
   ```

4. **実行計画ドキュメントの作成**

   **a) 情報収集**
   - タスクの目的と要件を理解
   - 既存のコードベースを調査
   - 関連ファイルとディレクトリを特定
   - 既存の仕様書（requirements.md、design.md、tasks.md）があれば参照

   **b) 計画作成**
   - Taskツールで `plan-writer` エージェントを呼び出し
   - または直接作成
   - 出力: `<タイムスタンプ>_plan.md`

   計画には以下を含める：
   - 実装の概要（目的、スコープ、期待される成果）
   - ステップバイステップの実行計画
   - 関連する重要ファイル（修正対象、参照ファイル、新規作成）
   - 検証手順（テスト、品質チェック）
   - 注意点・リスク（潜在的な問題、フォールバック）

5. **出力完了の報告**
   - 出力したファイルのパス
   - 計画の概要
   - 次のステップの提案

### 出力ファイル

```
.claude/plans/<識別子>/
└── YYYY_MMDD_HHMM_SS_plan.md  # 実行計画
```

### plan.mdのテンプレート

```markdown
# 実行計画: [タスク名]

## 概要
- **目的**: [実装の目的]
- **スコープ**: [実装範囲]
- **期待される成果**: [期待結果]

## 実行計画

### Step 1: [ステップ名]
**目的**: [このステップの目的]
**作業内容**:
- [作業項目1]
- [作業項目2]

**使用ツール**:
- [ツール/コマンド]

**完了条件**:
- [完了の判断基準]

### Step 2: [ステップ名]
...

## 関連ファイル

### 修正対象
- `path/to/file1.ts` - [修正内容]

### 参照ファイル
- `path/to/reference.ts` - [参照理由]

### 新規作成
- `path/to/newfile.ts` - [作成理由]

## 検証手順

### テスト
- [テスト項目1]

### 品質チェック
- [チェック項目1]

## 注意点・リスク

### 潜在的な問題
- [問題1]: [対策]

### フォールバック
- [リスクシナリオ]: [代替案]
```

### 注意事項

- **タイムスタンプ**: 必ず日本時間のタイムスタンプを使用
- **バージョン管理**: 新しいタイムスタンプのファイルとして保存し、既存ファイルは上書きしない
- **具体性**: 抽象的な表現を避け、具体的なアクションを記述
- **実行可能性**: 各ステップが実行可能であることを確認
- **ファイル末尾**: ファイルの末尾に空行を追加
- **日本語**: すべてのドキュメントは日本語で記述

### 期待される成果

1. 明確で実行可能なステップバイステップの計画
2. 実装に必要な全ての情報を含む包括的な計画書
3. リスクと対策を考慮した現実的な計画
