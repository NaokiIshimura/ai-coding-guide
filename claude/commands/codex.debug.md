---
allowed-tools: Read, Bash(codex:*)
description: Codexにデバッグを依頼する
---

## タスク

Codexにデバッグを依頼します。エラーの原因特定と修正案の提示を行います。

### 1. エラー情報の収集

ユーザーから提供されたエラー情報を収集します：

```bash
# エラー情報の確認
if [ -z "$ERROR_MESSAGE" ]; then
    echo "デバッグ情報を入力してください:"
    echo "- エラーメッセージ"
    echo "- スタックトレース"
    echo "- 再現手順"
else
    echo "エラー情報を受け取りました"
fi
```

### 2. 関連ファイルの特定

エラーに関連するファイルを特定します：

```bash
# スタックトレースからファイルを抽出
# 例: "at login (/path/to/file.ts:42:10)"
RELATED_FILES=$(echo "$ERROR_MESSAGE" | grep -oE '\/[^:]+\.(ts|js|tsx|jsx)' | sort -u)

# ファイルが特定できた場合、その内容を読み込む
for file in $RELATED_FILES; do
    if [ -f "$file" ]; then
        echo "関連ファイル: $file"
    fi
done
```

### 3. デバッグプロンプトの生成

エラー情報を含むプロンプトを生成します：

```markdown
# デバッグ依頼

## エラー情報

### エラーメッセージ
```
<エラーメッセージ>
```

### スタックトレース
```
<スタックトレース（あれば）>
```

### 再現手順
1. <手順1>
2. <手順2>
...

### 期待する動作
<本来あるべき動作>

### 実際の動作
<実際に起きている動作>

## 関連ファイル

### <ファイル名1>
```<language>
<ファイル内容（該当箇所周辺）>
```

### <ファイル名2>
```<language>
<ファイル内容（該当箇所周辺）>
```

## デバッグ依頼内容

以下の順序で分析してください:

### 1. 問題の特定
- エラーの直接的な原因
- 根本原因（Root Cause）
- 影響範囲

### 2. 原因分析
- なぜこのエラーが発生したか
- どのような条件で再現するか
- 他に影響を受ける箇所はないか

### 3. 修正案の提示
- **推奨修正方法**（最も適切な解決策）
- **代替案1**（別のアプローチ）
- **代替案2**（さらに別のアプローチ）

### 4. 予防策
- 同様のエラーを防ぐための方法
- テストケースの追加
- コードレビューのポイント

## 出力形式

### エラーの原因
<原因の説明>

### 修正案（推奨）
```<language>
<修正後のコード>
```

### 修正箇所の説明
<どこをどのように修正したか>

### テスト方法
<修正が正しいことを確認する方法>

### 予防策
<今後同じエラーを防ぐための方法>
```

### 4. Codex実行

`codex exec` コマンドでデバッグを実行します：

```bash
# タイムスタンプ生成
TIMESTAMP=$(TZ=Asia/Tokyo date +"%Y_%m%d_%H%M_%S")

# 出力ディレクトリ
OUTPUT_DIR=".claude/plans/codex"
mkdir -p "$OUTPUT_DIR"

# Codex実行
codex exec \
  --model auto \
  --sandbox workspace-write \
  --ask-for-approval on-failure \
  "$PROMPT"

# 結果を記録
EXIT_CODE=$?
RESULT_FILE="$OUTPUT_DIR/${TIMESTAMP}_debug_result.md"
```

### 5. デバッグ結果の整形と保存

結果をマークダウン形式で保存します：

```markdown
# Codex実行結果: デバッグ

## 実行情報

- **実行日時**: $(TZ=Asia/Tokyo date +"%Y年%m月%d日 %H:%M:%S")
- **操作種別**: debug
- **終了コード**: $EXIT_CODE

## エラー情報

### エラーメッセージ
<元のエラーメッセージ>

### 関連ファイル
- <ファイル1>
- <ファイル2>

## デバッグ結果

<Codexによる分析結果>

## 修正案

<Codexが提示した修正案>

## テスト手順

<修正を検証する手順>

## 次のアクション

1. 修正案を適用
2. テストを実行して動作を確認
3. 同様のエラーがないか確認
4. 予防策を実施
```

### 6. ユーザーへの通知

デバッグ完了後、結果を通知します：

```
Codexによるデバッグが完了しました。

結果ファイル: .claude/plans/codex/<timestamp>_debug_result.md

原因: <エラーの原因>

推奨修正方法:
<修正案の概要>

次のステップ:
1. 修正案を確認してください
2. 修正を適用してください
3. テストを実行してください
4. 問題が解決したか確認してください
```

## デバッグの種類

### 1. 構文エラー
- SyntaxError
- 括弧の不一致
- セミコロンの欠落
- インポートエラー

### 2. 実行時エラー
- TypeError
- ReferenceError
- RangeError
- NullPointerException

### 3. ロジックエラー
- 期待と異なる動作
- 計算結果の誤り
- 条件分岐の誤り
- ループの誤り

### 4. 非同期エラー
- Promise rejection
- Async/await の誤用
- コールバック地獄
- 競合状態（Race Condition）

### 5. パフォーマンス問題
- メモリリーク
- 無限ループ
- 過度な再レンダリング
- 非効率なアルゴリズム

## エラーハンドリング

### エラー情報が不足している場合

```
警告: エラー情報が不足しています

より正確なデバッグのため、以下の情報を提供してください:
- エラーメッセージの全文
- スタックトレース
- エラーが発生する手順
- 期待する動作と実際の動作

使用例:
/codex.debug
エラー: TypeError: Cannot read property 'name' of undefined
ファイル: src/auth/login.ts:42
手順: ログインボタンをクリックした時
```

### Codex実行失敗時

```
エラー: Codex実行が失敗しました（終了コード: <code>）

考えられる原因:
- エラー情報が不明瞭
- 関連ファイルが見つからない
- 問題が複雑すぎる

対処方法:
1. エラー内容を確認: .claude/plans/codex/<timestamp>_debug_result.md
2. より詳細なエラー情報を提供して再実行
3. 問題を小さな単位に分割
```

### 修正後もエラーが継続する場合

```
警告: 修正後もエラーが継続しています

対処方法:
1. 修正が正しく適用されたか確認
2. 他の関連ファイルも修正が必要か確認
3. より詳細な情報を提供して再度デバッグ
4. 必要に応じて開発チームに相談
```

## 使用例

### 基本的な使用方法

```
/codex.debug TypeError: Cannot read property 'name' of undefined
```

### 詳細なエラー情報を提供

```
/codex.debug
エラー: TypeError: Cannot read property 'name' of undefined
ファイル: src/auth/login.ts:42
スタックトレース:
  at login (src/auth/login.ts:42:10)
  at handleSubmit (src/components/LoginForm.tsx:28:5)
再現手順:
1. ログインフォームを開く
2. ユーザー名とパスワードを入力
3. ログインボタンをクリック
期待する動作: ログインが成功する
実際の動作: エラーが発生する
```

### パフォーマンス問題のデバッグ

```
/codex.debug
問題: ページの読み込みが非常に遅い
ファイル: src/components/DataTable.tsx
現象: 10000行のテーブルをレンダリングすると5秒以上かかる
期待: 1秒以内に表示される
```

### ロジックエラーのデバッグ

```
/codex.debug
問題: 合計金額の計算が正しくない
ファイル: src/utils/calculator.ts
入力: [100, 200, 300]
期待する結果: 600
実際の結果: 6000
```

## 注意事項

- **重要**: 修正後は必ずテストを実行してください
- エラーメッセージは可能な限り詳細に提供してください
- スタックトレースは省略せずに全体を提供してください
- 再現手順を明確に記載してください
- 期待する動作と実際の動作を明確に区別してください
- 修正後、同様のエラーがないか確認してください
- ログやデバッグ出力を活用してください
